<!DOCTYPE html>
<!--
   COLLABORATORS:
	Nethanel Roitman
  -->
<html>
  <head>
	<link href='http://fonts.googleapis.com/css?family=Fredericka the Great' rel='stylesheet' type='text/css'>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Do.It</title>
    <link type="text/css" href="main_page_style.css" rel="stylesheet" />

	<script type="text/javascript" src="external_js/jquery-1.9.0.min.js"></script>
	<script type="text/javascript" src="external_js/jquery-ui-1.10.4.custom.js"></script>
	<script type="text/javascript" src="data.js"></script>
	<script type="text/javascript" src="external_js/jquery.json-2.4.js"></script>
	
	<script type="text/javascript"> 
		//Drag task start
		function dragTask(e) {
			e.dataTransfer.setData("Text", e.target.id);
		}
		
		//Drop task to column
		function dropTask(e) {
			target = $('#' + e.target.id);
			if (target.attr('class') == 'task_col') {
				//e.preventDefault();
				
				var data = e.dataTransfer.getData("Text");
			
				target.append($('#' + data));
				var assigned = e.target.id.substring(0, e.target.id.length - 4);
				assigned = (assigned == 'Optional') ? null : assigned; //Set assigned to null if it was 'Optional'
				d.changeAssignment(data, assigned, null);
			}
			else {
				//There should be a way to find the column from 'target'... But it doesn't always work
			}
			e.preventDefault();
		}
		
		function allowDrop(e) {
			e.preventDefault();
		}
	
		$(document).ready(function() {
		
			var doneLoading = function() {        
				//Load all tasks
				var tasks = d.getAllTasks();
				for(var i=0; i < tasks.length; i++){
					var task_to_add = '<div class="task" draggable="true" ondragstart="dragTask(event)" id="' + tasks[i].id + '">';
					task_to_add += '<div class="task_text">' + tasks[i].name + '</div>';
					task_to_add += '<div class="task_details">';
					task_to_add += '<div class="task_date">Due: ' + tasks[i].month + '/';
					task_to_add += tasks[i].day + '/' + tasks[i].year + '</div>';
					if (tasks[i].reward){
						task_to_add += '<div class="task_reward">$' + tasks[i].reward + '</div>';
					}
					else{
						task_to_add += '<div class="task_reward">$0</div>';
					}
					task_to_add += '</div>';
					
					
					task_to_add += '<div class="done">Did.It</div>';
					
					
					if (tasks[i].done){
						task_to_add += '<ul class="list"><li>Mark as not done</li>';
					}
					else{
						task_to_add += '<ul class="list"><li>Mark as done</li>';
					}
					task_to_add += '<li>Edit</li><li>Delete</li></ul>';
					task_to_add += '</div>';										
					
					if (tasks[i].assigned){
						$('#' + tasks[i].assigned + '_col').append(task_to_add);
					}
					else{
						$('#Optional_col').append(task_to_add);
					}
					
					if (tasks[i].done){
						//green background for done tasks
						$('#' + tasks[i].id).css('background', '#32cd32');
					} else {
						//hide "Did.It" text for not done tasks
						$('#' + tasks[i].id).find('.done').css('display','none');
					}					
				}
				
				//Set popup menu for tasks
				$('.task').styleddropdown();
			}
			
			openMenu = null;
			
			d = new Data(doneLoading);
		});

		//Popup menu for tasks
		(function($){
			$.fn.styleddropdown = function(){
				return this.each(function(){
					var task = $(this)
					
					//Show menu when clicking on task
					task.click(function(e) {
						if (openMenu && openMenu != task.find('.list')){
							openMenu.fadeOut(1);
						}
						e.stopPropagation();
						
						task.find('.list').fadeIn(1);
						openMenu = task.find('.list');
					
						//Hide menu when 'escape' is pressed
						$(document).keyup(function(event) { 
							if(event.keyCode == 27) {
							task.find('.list').fadeOut(1);
							}
						});
						
						
						//Trying to make it disappear when the user clicks elsewhere
						$(document).click(function(e) {						
							task.find('.list').fadeOut(1);
						});
						
						//Hide menu when mouse exits
						task.find('.list').hover(function(){ },
							function(){
								$(this).fadeOut(1);
							});
					});
					
					//Click on menu
					task.find('.list li').click(function(e) {				
						//Do something with what was clicked
						if ($(this).html() == 'Edit'){
						
							//CHANGE THE ADDRESS TO BE CREATE TASK PAGE!!!!!!!!!
							document.location = "index.html?id=" + task[0].id;
						}
						else if ($(this).html() == 'Delete'){
							var toDelete = confirm("Are you sure you want to delete this task?");
							if (toDelete){
								task[0].parentNode.removeChild(task[0]);
								d.deleteTask(task[0].id, null);
							}
						}
						else if ($(this).html() == 'Mark as done'){
							d.markDone(task[0].id, null)
							$(this).html('Mark as not done');
							task.css('background', '#32cd32');
							task.find('.done').css('display','initial');
						}
						else { //Mark as Undone
							d.markNotDone(task[0].id, null);
							$(this).html('Mark as done');
							task.css('background', '#dddddd');
							task.find('.done').css('display','none');
						}
						//task.find('.task_text').html($(this).html());
						
						
						task.find('.list').fadeOut(1);
						e.stopPropagation();
					});
				});
			};
		})(jQuery);		
	</script>

  </head>
  <body>
	<div class="logo">Do.It</div>
    
	<div class="calendar">
		<button class="calendar_button_today" id="Calendar_Button_Today">
			Today
		</button>
		<button class="calendar_button" id="Calendar_Button_Left">
			<
		</button>
		<button class="calendar_button" id="Calendar_Button_Right">
			>
		</button>
		<div class="calendar_date_text">
			April 13-19, 2014
		</div>
	</div>
	
	<div class="wrapper">
		<form action="index.html" method="get">
			<button class="button" type="submit" id="Create_Task_Button">Create Task</button> 
		</form>
	</div>
	
	<hr></hr>
	
	
	<!--Table set up for the actual content of the game -->
	<table id="Task_Table" cellspacing="40" width="100%">
		<!--These are the headers of the table columns based on the languages selected in the javascript code-->
		<tr>
			<td class="name">
				<h2>Molly</h2>
			</td>
			<td class="name">
				<h2>North</h2>
			</td>
			<td class="name">
				<h2>Andrew</h2>
			</td>
			<td class="name">
				<h2>Optional</h2>
			</td>
		</tr>
		<!--This is the row displaying everything the user will interact with. (The random word to translate, the input box, and submit button).-->
		<tr>
			<td id="Molly_col" class='task_col' ondrop="dropTask(event)" ondragover="allowDrop(event)"></td>
			<td id="North_col" class='task_col' ondrop="dropTask(event)" ondragover="allowDrop(event)"></td>
			<td id="Andrew_col" class='task_col' ondrop="dropTask(event)" ondragover="allowDrop(event)"></td>
			<td id="Optional_col" class='task_col' ondrop="dropTask(event)" ondragover="allowDrop(event)"></td>
		</tr>
	</table>

  </body>
</html>
