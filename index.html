<!DOCTYPE html>


<html>

<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
    <title>Task Creation</title>

    <!-- Load style sheets -->
    <link rel="stylesheet" type="text/css" href="styles.css" />

    <!-- Load any supplemental Javascript libraries here -->
    <script type="text/javascript" src="external_js/jquery-1.9.0.min.js"></script>


    <script type="text/javascript" src="jquery-ui-1.10.4 3.custom/js/jquery-ui-1.10.4.custom.min.js"></script>

	<script type="text/javascript" src="external_js/jquery.json-2.4.js"></script>

    <link rel="stylesheet" type ="text/css" href="jquery-ui-1.10.4 3.custom/css/redmond/jquery-ui-1.10.4.custom.min.css">


    <!-- Bootstrap
    <link rel="stylesheet" type="text/css" href="bootstrap-3.1.1-dist/css/bootstrap.min.css" /> -->

	<script type="text/javascript" src="data.js"></script>

<script>
  $(function() {
    $( "#datepicker" ).datepicker({
		minDate: 0
	});
  });
	$.extend({
		getUrlVars : function() {
			var vars = [], hash;
			var hashes = window.location.href.slice(
					window.location.href.indexOf('?') + 1).split('&');
			for ( var i = 0; i < hashes.length; i++) {
				hash = hashes[i].split('=');
				vars.push(hash[0]);
				vars[hash[0]] = hash[1];
			}
			return vars;
		},
		getUrlVar : function(name) {
			return $.getUrlVars()[name];
		}
	});

	function bindDeleteReminders() {
		//Happens when a user deletes a reminder
		$('.deleteReminder').click(deleteButtonPressed);
	}
	
	function deleteButtonPressed(e) {
		var table = document.getElementById("table");					
		if (table.rows.length ==  7) {
			//Deleted only reminder
			document.getElementById('reminder0').value = '';
		}
		else {
			//There's at least two reminder rows (including the top-most one)
			var element = e.currentTarget.parentElement.parentElement;
			element.parentNode.removeChild(element);

			//changes id of rows and their input boxes to be what we expect them to be post delete
			var rows = table.rows;
			for (var i = 5; i < rows.length - 1; i++) {
				var rowObj = $('#' + rows[i].id);
				rowObj.find('.reminder').attr('id', 'reminder' + (i - 5));
				rows[i].id = 'reminderRow' + (i - 5);

				//Makes sure the first reminder row has text
				if (i == 5) {
					rowObj.find('.firstCol').html('Reminders:');
				}
			}
		}
	}	

    function checkAddress(checkbox) {
        if (checkbox.checked) {
            document.getElementById('checkText').innerHTML = 'daily';
        } else {
            document.getElementById('checkText').innerHTML = '';
        }
    }

	$(document).ready(function() {
		var doneLoading = function() {
			if ($.getUrlVar('id')) {
				task = d.getTask($.getUrlVar('id'));
				if (task) {
					//edit task
					$('#title').html('Edit Task');

					document.getElementById('taskTitle').value = task.name;

					$('#datepicker').datepicker("setDate", new Date(task.year, task.month, task.day));

					document.getElementById('assigned').value = task.assigned;
					document.getElementById('reward').value = task.reward;

					//Makes page show current reminders set for task
					if (task.reminders && task.reminders.length > 0) {
						document.getElementById('reminder0').value = task.reminders[0];

						var table = document.getElementById("table");
						for (var i = 1; i < task.reminders.length; i++) {
							var row = table.insertRow(5 + i);

							row.id = 'reminderRow' + i;

							var cell1 = row.insertCell(0);
							var cell2 = row.insertCell(1);
							var cell3 = row.insertCell(2);

							cell1.className = "firstCol";
							cell2.className = "reminder_td";
							cell2.innerHTML = '<input type="text" name="reminder' + i + '" id="reminder' + i + '" value="' + task.reminders[i] + '" class="reminder"><div class="daysBefore">days before</div>';
							cell3.innerHTML = '<img src="delete.ico" alt="Delete Reminder" height="24px" width="24px" class="deleteReminder" id="btnDelete' + i + '">';
						}
					}

					document.getElementById('details').value = task.details;
				}
			}

			$("#assigned").autocomplete({
				minLength: 0,
				delay: 0,
				source: d.getKids()
			}).on("focus", function () {
				$(this).autocomplete("search", "");
			});
			
			//Bind the click operation for delete reminder icons
			bindDeleteReminders();

			//Creates/Saves task. Should display dialog box warning user about the editing of repeating tasks.
			$("#btnSave").click(function() {
				var callback = function() {document.location = 'main%20page%20v1%204-10-14.html';}
			
				if ($.getUrlVar('id') && d.getTask($.getUrlVar('id'))) {
					task = d.getTask($.getUrlVar('id'));
					d.updateTask(task.id, "Edited Task", new Date(task.year, task.month, task.day), task.repeat, task.assigned, task.reward, task.reminders, task.details, callback);
				}
				else {
					d.createTask("New Task", new Date(), null, null, null, [0,1,2], "no details for this task", callback);					
				}
			});

			//Back button clicked. Should ideally display dialog box warning user that he's discarding his changes (if he made any)
			$("#btnBack").click(function() {
				document.location = 'main%20page%20v1%204-10-14.html';
			});

			//Add new reminder button clicked
			$("#btnNewReminder").click(function() {
				var table = document.getElementById("table");
				var i = table.rows.length - 6;

				var row = table.insertRow(5 + i);

				row.id = 'reminderRow' + i;

				var cell1 = row.insertCell(0);
				var cell2 = row.insertCell(1);
				var cell3 = row.insertCell(2);

				cell1.className = "firstCol";
				cell2.className = "reminder_td";
				cell2.innerHTML = '<input type="text" name="reminder' + i + '" id="reminder' + i + '" class="reminder"><div class="daysBefore">days before</div>';
				cell3.innerHTML = '<img src="delete.ico" alt="Delete Reminder" height="24px" width="24px" class="deleteReminder" id="btnDelete' + i + '">';
				
				

				//Bind the click operation for delete reminder icons				
				$('#btnDelete' + i).click(deleteButtonPressed);
				//bindDeleteReminders();
			});
		}

		d = new Data(doneLoading);
	});
</script>


</head>

<body>
    <h1 id='title'>Create Task</h1>
    <button type="button" class="back_button" id='btnBack'>Back</button>

    <button type="button" class="save_button" id='btnSave'>Save</button>

	<hr></hr>

    <table id='table'>
        <tr>
            <td>Task: </td>
            <td><input type="text" name="taskTitle" id="taskTitle"></td>
        </tr>

        <tr>
            <td>Deadline: </td>
            <td><input type="text" id="datepicker"></td>
        </tr>

		<tr>
            <td>Repeat: </td>
            <td class="repeat_td" >
				<input type="checkbox" id="checkAddress" onclick="checkAddress(this)" checked="checked" autocomplete="off" />
				<p size=3 id= "checkText" style="display:inline;font-size:16px">daily</p>
			</td>
        </tr>

        <tr>
            <td>Assigned To: </td>
            <td><input type="text" name="assigned" id="assigned"></td>
        </tr>

        <tr>
            <td>Reward ($):</td>
            <td><input type="text" name="reward" id="reward"></td>
        </tr>
        <tr id="reminderRow0">
            <td class="firstCol">Reminders:</td>
            <td class="reminder_td"><input type="text" name="reminder0" id="reminder0" class="reminder"><div class="daysBefore">days before</div></td>
			<td><img src="delete.ico" alt="Delete Reminder" height="24px" width="24px" class="deleteReminder" id="btnDelete0">
        </tr>
		<tr>
			<td></td>
			<td><button type="button" class=button" id='btnNewReminder'>Add New Reminder</button></td>
		</tr>
    </table>

    Details: <br>
    <textarea rows="4" cols="50" placeholder="Enter details here..." id="details"></textarea>

</body>

</html>
